<div id="Zauberberg">
    <script>
        /**
         * Generell
         */

        addListener('START', function (event) {
            var stringFromServer = event.data;
            if (stringFromServer === "HOST") {
                document.getElementById("closeButton").style.visibility = "visible";
            }
            document.getElementById("overlayMsg").style.visibility = "hidden";
        });

        addListener('PLAYERLEFT', function (event) {
            document.getElementById("overlayMsg").innerHTML = "Ein Spieler hat das Spiel verlassen!";
            document.getElementById("overlayMsg").style.visibility = "visible";
        });

        addListener('CLOSE', function (event) {
            document.getElementById("Player").innerHTML = "Spiel wurde vom Host beendet!";
        });

        function startGame() {
            sendDataToServer("START");
        }

        function closeGame() {
            sendDataToServer("CLOSE");
        }

        function errorMsg(msg) {
            //todo create Error Message
        }
    </script>
    <div id="Spielfeld">
        <div id="grid">
        </div>
    </div>
    <script>
        /**
         * Spielfeld
         */
        /* BEISPIEL TICTACTOE
        var emptyImg = "/Zauberberg/images/empty.png";
        var xImg = "/Zauberberg/images/x.jpg";
        var oImg = "/Zauberberg/images/o2.png";
        var statusWait = true;

        var arrFields = [0, 0, 0, 0, 0, 0, 0, 0, 0];
        var sentFields = [0, 0, 0, 0, 0, 0, 0, 0, 0];

        function setField(x) {
            sentFields[x] = 1;
        }

        function getImg(x) {
            if (x == 1) return xImg;
            else if (x == 2) return oImg;
            return emptyImg
        }

        function initFields() {
            var parent = document.getElementById("grid");
            for (var i = 0; i < 9; i++) {
                var img = document.createElement("img");
                img.id = "img" + i;
                img.src = emptyImg;
                img.width = "148";
                img.height = "153";
                img.style.position = "absolute";
                img.style.top = (Math.floor((i / 3)) * 172 + 11) + "px";
                img.style.left = ((i % 3) * 170 + 11) + "px";
                img.onclick = function () {
                    if (arrFields[this.id[3]] == 0 && statusWait == false) {
                        setField(this.id[3]);
                        updateGameState();
                    }
                };
                parent.appendChild(img);
            }
        }

        window.onload = initFields;

        function redraw() {
            for (var i = 0; i < 9; i++) {
                var img = document.getElementById('img' + i);
                img.src = getImg(arrFields[i]);
            }
        }

        */
    </script>

    <!-- START Aktionsfläche -->
    <div id="Aktionsfläche" style="margin: 10px;">
        <div id="GameControl">
            <button id="closeButton" class="button" onclick="closeGame()" style="visibility: hidden">Beenden</button>
        </div>
        <div id="Spielzustand">
            <div id="SpielerRot"><span class="spielername" style="color: #EF5350">Rot</span>
                <img id="RotStein1" src="images/x.jpg" class="spielzustandStein"/>
                <img id="RotStein2" src="images/x.jpg" class="spielzustandStein"/>
            </div>
            <div id="SpielerBlau"><span class="spielername" style="color: #42A5F5">Blau</span>
                <img id="BlauStein1" src="images/x.jpg" class="spielzustandStein"/>
                <img id="BlauStein2" src="images/x.jpg" class="spielzustandStein"/>
            </div>
            <div id="SpielerGrün"><span class="spielername" style="color: #66BB6A">Grün</span>
                <img id="GrünStein1" src="images/x.jpg" class="spielzustandStein"/>
                <img id="GrünStein2" src="images/x.jpg" class="spielzustandStein"/>
            </div>
            <div id="SpielerGelb"><span class="spielername" style="color: #FFEE58">Gelb</span>
                <img id="GelbStein1" src="images/x.jpg" class="spielzustandStein"/>
                <img id="GelbStein2" src="images/x.jpg" class="spielzustandStein"/>
            </div>
            <div id="SpielerGrau"><span class="spielername" style="color: #BDBDBD">Grau</span>
                <img id="GrauStein1" src="images/x.jpg" class="spielzustandStein"/>
                <img id="GrauStein2" src="images/x.jpg" class="spielzustandStein"/>
            </div>
        </div>
        <div id="karten-Hand" class="kartenliste">
            <div class="karte"><img src="/Zauberberg/images/Zahlenkarte1.png" class="karteBild" alt="1"/></div>
            <div class="karte"><img src="/Zauberberg/images/Zahlenkarte2.png" class="karteBild" alt="2"/></div>
            <div class="karte"><img src="/Zauberberg/images/Zahlenkarte3.png" class="karteBild" alt="3"/></div>
        </div>
        <div style="position: relative; width: 800px; border-top: solid 1px #555555; border-bottom: solid 1px #555555;">
            <div id="karten-Legen" class="kartenliste">
                <div class="karte"><img src="/Zauberberg/images/Zahlenkarte1.png" class="karteBild" alt="1"/></div>
                <div class="karte"><img src="/Zauberberg/images/Zahlenkarte2.png" class="karteBild" alt="2"/></div>
                <div class="karte"><img src="/Zauberberg/images/Zahlenkarte3.png" class="karteBild" alt="3"/></div>
            </div>
            <button id="kartenLegenBtn" class="button" onclick="kartenLegenBtnAction()">
                Karten legen
            </button>
        </div>
        <div style="position: relative; width: 800px">
            <div id="karten-Tauschen" class="kartenliste">
                <div class="karte"><img src="/Zauberberg/images/Zahlenkarte1.png" class="karteBild" alt="1"/></div>
                <div class="karte"><img src="/Zauberberg/images/Zahlenkarte2.png" class="karteBild" alt="2"/></div>
                <div class="karte"><img src="/Zauberberg/images/Zahlenkarte3.png" class="karteBild" alt="3"/></div>
                <div id="joker0" class="karte jokerkarte" data-jokervalue="1">
                    <img id="joker0_1" src="/Zauberberg/images/Zahlenkarte1.png" class="joker"
                         onclick="jokerSet(0, 1)" style="opacity: 1;"/>
                    <img id="joker0_2" src="/Zauberberg/images/Zahlenkarte2.png" class="joker"
                         onclick="jokerSet(0, 2)" style="opacity: 0.2;"/>
                    <img id="joker0_3" src="/Zauberberg/images/Zahlenkarte3.png" class="joker"
                         onclick="jokerSet(0, 3)" style="opacity: 0.2;"/>
                    <img id="joker0_4" src="/Zauberberg/images/Zahlenkarte4.png" class="joker"
                         onclick="jokerSet(0, 4)" style="opacity: 0.2;"/>
                    <img id="joker0_5" src="/Zauberberg/images/Zahlenkarte5.png" class="joker"
                         onclick="jokerSet(0, 5)" style="opacity: 0.2;"/>
                </div>
            </div>
            <button id="kartenTauschenBtn" class="button" onclick="kartenTauschenBtnAction()">
                Karten tauschen
            </button>
        </div>
    </div>
    <script>    /** Javascript für die Aktionsfläche (Zauberberg.js wird durch Serverfehler nicht geladen!) */
    Sortable.create(document.getElementById("karten-Hand"), {
        group: {name: "karten", put: true, pull: true},
        draggable: 'div',
        animation: 150
    });
    Sortable.create(document.getElementById("karten-Legen"), {
        group: {
            name: "karten",
            put: function () {
                return document.getElementById("karten-Legen").childElementCount < 3;
            },
            pull: function () {
                return document.getElementById("karten-Legen").childElementCount > 2;
            }
        },
        draggable: 'div',
        animation: 150
    });
    Sortable.create(document.getElementById("karten-Tauschen"), {
        group: {name: "karten", put: true, pull: true},
        draggable: 'div',
        animation: 150
    });

    function kartenLegenBtnAction() {
        var output = {
            "Eventname": "KARTENLEGEN",
            "karte1Typ": "Null",
            "karte2Typ": "Null",
            "karte3Typ": "Null",
            "karte1Wert": "Null",
            "karte2Wert": "Null",
            "karte3Wert": "Null"
        };
        var kartencontainer = document.getElementById("karten-Legen");
        //console.log(kartencontainer); // LOG
        for (var i = 0; i < kartencontainer.childElementCount; i++) {
            if (kartencontainer.children[i].classList.contains("jokerkarte")) { // Ist ein Joker
                output["karte" + (i + 1) + "Typ"] = "Joker";
                output["karte" + (i + 1) + "Wert"] = kartencontainer.children[i].getAttribute("data-jokervalue");
            } else { // Ist normale Karte
                output["karte" + (i + 1) + "Typ"] = "Normal";
                output["karte" + (i + 1) + "Wert"] = kartencontainer.children[i].children[0].alt;
            }
        }
        console.log(output);
        sendDataToServer(JSON.stringify(output));
    }

    function kartenTauschenBtnAction() {
        var output = {
            "Eventname": "KARTENTAUSCHEN",
            "karte1": "Null",
            "karte2": "Null",
            "karte3": "Null",
            "karte4": "Null",
            "karte5": "Null"
        };
        var kartencontainer = document.getElementById("karten-Tauschen");
        //console.log(kartencontainer); // LOG
        for (var i = 0; i < kartencontainer.childElementCount; i++) {
            if (kartencontainer.children[i].classList.contains("jokerkarte")) { // Ist ein Joker
                output["karte" + (i + 1)] = "Joker";
            } else { // Ist normale Karte
                output["karte" + (i + 1)] = kartencontainer.children[i].children[0].alt;
            }
        }
        console.log(output);
        console.log(JSON.stringify(output));
        sendDataToServer(JSON.stringify(output));
    }

    function jokerSet(jokerID, value) {
        document.getElementById("joker" + jokerID + "_" + 1).style.opacity = "0.2";
        document.getElementById("joker" + jokerID + "_" + 2).style.opacity = "0.2";
        document.getElementById("joker" + jokerID + "_" + 3).style.opacity = "0.2";
        document.getElementById("joker" + jokerID + "_" + 4).style.opacity = "0.2";
        document.getElementById("joker" + jokerID + "_" + 5).style.opacity = "0.2";
        document.getElementById("joker" + jokerID + "_" + value).style.opacity = "1";

        document.getElementById("joker" + jokerID).setAttribute("data-jokervalue", value.toString());

        // document.getElementById("joker" + jokerID + "_" + 1).classList.remove("chosenJoker");
        // document.getElementById("joker" + jokerID + "_" + 3).classList.remove("chosenJoker"); todo remove old when alternative works
        // document.getElementById("joker" + jokerID + "_" + 2).classList.remove("chosenJoker");
        // document.getElementById("joker" + jokerID + "_" + 4).classList.remove("chosenJoker");
        // document.getElementById("joker" + jokerID + "_" + 5).classList.remove("chosenJoker");
        // document.getElementById("joker" + jokerID + "_" + value).classList.add("chosenJoker");
    }

    addListener('UPDATESPIELZUSTAND', function (event) {
        var stringFromServer = event.data;
        var data = JSON.parse(stringFromServer);
        //var kartencontainer = document.getElementById("karten-Hand");
        for (var colour in data) {
            if (data[colour]["Aktiv"] === "1") {
                document.getElementById("Spieler" + colour).style.visibility = "visible";

                if (data[colour]["Fokus"] === "1") {
                    document.getElementById("Spieler" + colour).children[0].style.textDecoration = "underline solid white";
                } else {
                    document.getElementById("Spieler" + colour).children[0].style.textDecoration = "";
                }

                if (data[colour]["Steine"] === "2") {
                    document.getElementById(colour + "Stein1").style.visibility = "visible";
                    document.getElementById(colour + "Stein2").style.visibility = "visible";
                } else if (data[colour]["Steine"] === "1") {
                    document.getElementById(colour + "Stein1").style.visibility = "visible";
                    document.getElementById(colour + "Stein2").style.visibility = "hidden";
                } else {
                    document.getElementById(colour + "Stein1").style.visibility = "hidden";
                    document.getElementById(colour + "Stein2").style.visibility = "hidden";
                }

                if (data[colour]["BistDu"] === "1") {
                    document.getElementById("Spieler" + colour).children[0].style.fontWeight = "bold";
                } else {
                    document.getElementById("Spieler" + colour).children[0].style.fontWeight = "inherit";
                }
            } else {
                document.getElementById("Spieler" + colour).style.visibility = "hidden";
            }
        }
    });

    addListener('UPDATEKARTEN', function (event) {
        var stringFromServer = event.data;
        var arr = JSON.parse(stringFromServer);
        document.getElementById("karten-Legen").innerHTML = "";
        document.getElementById("karten-Tauschen").innerHTML = "";
        var kartencontainer = document.getElementById("karten-Hand");
        kartencontainer.innerHTML = "";
        var jokercount = 0;
        arr.forEach(function (kartenWert) {
            if (kartenWert === "Joker") {
                var jokerkarte = "<div id=\"joker" + jokercount + "\" class=\"karte jokerkarte\" data-jokervalue=\"1\">"
                for (var i = 1; i <= 5; i++) {
                    jokerkarte += "<img id=\"joker" + jokercount + "_" + i + "\" src=\"/Zauberberg/images/Zahlenkarte" + i + ".png\" class=\"joker\"" +
                        " onclick=\"jokerSet(" + jokercount + ", " + i + ")\" style=\"opacity: " + (i === 1 ? "1" : "0.2") + ";\"/>"
                }
                jokerkarte += "</div>";
                kartencontainer.append(jokerkarte);
                jokercount++;
            } else {
                kartencontainer.append("<img src='/Zauberberg/images/Zahlenkarte" + zahl + ".png' class='karte' alt='" + zahl + "'/>");// Der Zahlenwert wird im "alt" gespeichert
            }
        });
    });
    </script>
    <!-- ENDE Aktionsfläche -->
</div>

<span id="overlayMsg">Warte auf Mitspieler...</span>
<script>document.getElementById("overlayMsg").style.visibility = "hidden";</script>